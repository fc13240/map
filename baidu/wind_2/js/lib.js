var log="undefined"!=typeof console?function(){console.log.apply(console,arguments)}:function(){},getWindColor=function(){var t=.5,e=[{a:-10,b:0,c:[255,255,255,0]},{a:0,b:8.49,c:[152,219,248,.1]},{a:8.49,b:15.79,c:[50,100,255,t]},{a:15.79,b:30,c:[254,0,3,t]},{a:30,b:70,c:[209,103,211,t]},{a:70,b:90,c:[238,200,239,t]},{a:90,b:100,c:[255,255,255,t]}],i=e.length;return function(t,s,o){for(var n,a=s?t:Math.sqrt(Math.pow(t.x,2)+Math.pow(t.y,2)),r=e[i-1],h=0;i>h;h++){var l=e[h];if(a>=l.a&&a<l.b){r=l,n=e[h-1];break}}if(!n)return o?[255,255,255,0]:"rgba(255,255,255,0)";var u=n.c,c=r.c,f=u[0],y=u[1],p=u[2],d=u[3],m=c[0],v=c[1],g=c[2],x=c[3],M=(a-r.a)/(r.b-r.a),w=Math.floor(f+(m-f)*M),b=Math.floor(y+(v-y)*M),T=Math.floor(p+(g-p)*M),_=d+(x-d)*M;return o?[w,b,T,Math.floor(255*_)]:"rgba("+[w,b,T,_]+")"}}();Date.prototype.format=function(t,e){t||(t="yyyy-MM-dd hh:mm:ss");var i={"M{2}":this.getMonth()+1,"d{2}":this.getDate(),"h{2}":this.getHours(),"m{2}":this.getMinutes(),"q{2}":Math.floor((this.getMonth()+3)/3)};e||(i["s{2}"]=this.getSeconds(),i["S{2}"]=this.getMilliseconds()),/(y{4}|y{2})/.test(t)&&(t=t.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var s in i)new RegExp("("+s+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?i[s]:("00"+i[s]).substr((""+i[s]).length)));return t},!function(t){function e(t){this.map=t}function i(){return!0}function s(t){function s(){var e=$("<canvas width="+p+" height="+x+' class="layer_vector">').css({left:0,top:0}).appendTo($("#map .BMap_mask")).get(0),s=(e.getContext("2d"),e),o=Math.pow(2,t.getZoom()-4),n=new f(e,s,M,Math.min(g,g*p/1e3,g*x/800),w);m=new u,m.zoom=o,m.animFunc=i,m.add(n),m.start(v)}if(d){var n=t.getBounds(),a=n.getSouthWest(),r=n.getNorthEast(),h=t.pointToPixel(a),c=t.pointToPixel(r),y=(h.x,c.y,t.getSize()),p=y.width,x=y.height,M=l.split(d,a.lng,r.lat,r.lng,a.lat),w=new e(t);setTimeout(function(){o(p,x,M,w,s)},500)}}function o(t,e,i,s,o){o&&o()}function n(){function e(){clearTimeout(l),clearTimeout(u),u=setTimeout(function(){m&&m.stop(),o.find(".layer_vector").remove(),s(r)},30)}function i(){m&&m.stop(),o.find(".layer_vector").remove(),clearTimeout(l),l=setTimeout(function(){e()},500)}var o=$("#map"),n=new BMap.TileLayer,a="http://map.yuce.baidu.com/tile4/?qt=tile&udt=20141224";n.getTilesUrl=function(t,e){var i=a+"&x="+t.x+"&y="+t.y+"&z="+e+"&styles=pl";return i};var r=new BMap.Map("map",{});t.map=r;var h=5;r.setMaxZoom(9),r.disableInertialDragging(),r.enableScrollWheelZoom(),r.enableContinuousZoom(),r.enableScrollWheelZoom(!0),r.enablePinchToZoom(),r.centerAndZoom(new BMap.Point(142.528035,32.43799),h),r.addControl(new BMap.NavigationControl),r.addControl(new BMap.ScaleControl),r.addEventListener("dragend",e),r.addEventListener("zoomend",e),r.addEventListener("dragstart",i),r.addEventListener("zoomstart",i);var l,u,c;$(window).on("resize",function(){i(),clearTimeout(c),c=setTimeout(function(){e()},10)}),r.setMapStyle({styleJson:[{featureType:"land",elementType:"all",stylers:{}},{featureType:"land",elementType:"all",stylers:{color:"#1c3289"}},{featureType:"boundary",elementType:"all",stylers:{color:"#6b9ecc"}},{featureType:"road",elementType:"all",stylers:{visibility:"off"}},{featureType:"water",elementType:"all",stylers:{color:"#3075c5"}},{featureType:"administrative",elementType:"labels.text.stroke",stylers:{color:"#1c3289",weight:"0.1",visibility:"on"}},{featureType:"label",elementType:"labels.text.fill",stylers:{color:"#ffffff",visibility:"on"}}]})}function a(){for(var t=(new Date).getHours(),e=t>=8&&20>t?8:20,i=12+3*Math.floor((t-e)/3)+"",s=i.length;3>s;s++)i="0"+i;return i}function r(t,e){var i;return function(){var s,o=[].slice.call(arguments),n=o.length;if(n>0){var a=o[n-1];$.isFunction(a)&&(s=a)}var r=new Date,h=t.apply(null,o),l=$.ajax({url:h,dataType:e||"jsonp",jsonp:"_cb",success:function(t){l.date==i&&s&&s(t)},error:function(){alert("数据加载出现错误，请重试！")}});l.date=i=r}}var h=function(t,e){this.x=t,this.y=e};h.polar=function(t,e){return new h(t*Math.cos(e),t*Math.sin(e))},h.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},h.prototype.copy=function(){return new h(this.x,this.y)},h.prototype.setLength=function(t){var e=this.length();if(e){var i=t/e;this.x*=i,this.y*=i}return this},h.prototype.setAngle=function(t){var e=length();return this.x=e*Math.cos(t),this.y=e*Math.sin(t),this},h.prototype.getAngle=function(){return Math.atan2(this.y,this.x)},h.prototype.d=function(t){var e=t.x-this.x,i=t.y-this.y;return Math.sqrt(e*e+i*i)};var l=function(t,e,i,s,o){this.x0=e,this.x1=s,this.y0=i,this.y1=o,this.field=t,this.w=t.length,this.h=t[0].length,this.maxLength=0;for(var n=0;n<this.w;n++)for(var a=0;a<this.h;a++)this.maxLength=Math.max(this.maxLength,t[n][a].length())};l.read=function(t,e){for(var i=[],s=t.gridWidth,o=t.gridHeight,n=0,a=0,r=0,u=0;s>u;u++){i[u]=[];for(var c=0;o>c;c++){var f=t.field[n++],y=t.field[n++],p=new h(f,y);if(e){var d=u/(s-1),m=c/(o-1),v=(t.x0*(1-d)+t.x1*d,t.y0*(1-m)+t.y1*m),g=Math.PI*v/180,x=p.length();x&&(a+=x*g,r+=g),p.x/=Math.cos(g),p.setLength(x)}i[u][c]=p}}var M=new l(i,t.x0,t.y0,t.x1,t.y1);return a&&r&&(M.averageLength=a/r),M},l.split=function(t,e,i,s,o){for(var n=t.w,a=t.h,r=t.x0,h=t.y0,u=(t.x1-r)/n,c=(t.y1-h)/a,f=[],y=i_x1=i_y0=i_y1=-1,p=t.field,d=0,m=p.length;m>d;d++){var v=r+u*(d-1);if(v>=e&&s>=v){-1==y?y=d:i_x1=d;for(var g=0,x=p[d],M=x.length;M>g;g++){var w=h+c*(g-1);w>=o&&i>=w&&(-1==i_y0?i_y0=g:i_y1=g)}}}y-=3,i_x1+=3,i_y0-=3,i_y1+=3;var b=10,T=7,_=i_x1-y;b>_&&(_=Math.ceil((b-_)/2),y=Math.max(0,y-_),i_x1=Math.min(i_x1+_,n-1));var S=i_y1-i_y0;T>S&&(S=Math.ceil((T-S)/2),i_y0=Math.max(0,i_y0-S),i_y1=Math.min(i_y1+S,a-1)),y=Math.max(0,y),i_x1=Math.min(i_x1,n-1),i_y0=Math.max(0,i_y0),i_y1=Math.min(i_y1,a-1),new_x0=r+y*u,new_x1=r+i_x1*u,new_y0=h+i_y0*c,new_y1=h+i_y1*c;for(var d=y;i_x1>d;d++){for(var z=[],m=i_y0;i_y1>m;m++)z.push(p[d][m]);f.push(z)}var P=new l(f,new_x0,new_y0,new_x1,new_y1);return P.maxLength=t.maxLength,P},l.prototype.inBounds=function(t,e){return t>=this.x0&&t<this.x1&&e>=this.y0&&e<this.y1},l.prototype.bilinear=function(t,e,i){var s=Math.floor(e),o=Math.floor(i),n=Math.ceil(e),a=Math.ceil(i),r=e-s,h=i-o;return this.field[s][o][t]*(1-r)*(1-h)+this.field[n][o][t]*r*(1-h)+this.field[s][a][t]*(1-r)*h+this.field[n][a][t]*r*h},l.prototype.getValue=function(t,e,i){var s=(this.w-1-1e-6)*(t-this.x0)/(this.x1-this.x0),o=(this.h-1-1e-6)*(e-this.y0)/(this.y1-this.y0),n=this.bilinear("x",s,o),a=this.bilinear("y",s,o);return i?(i.x=n,i.y=a,i):new h(n,a)},l.prototype.vectValue=function(t){return this.getValue(t.x,t.y)},l.constant=function(t,e,i,s,o,n){var a=new l([[]],i,s,o,n);return a.maxLength=Math.sqrt(t*t+e*e),a.getValue=function(){return new h(t,e)},a};var u=function(t,e,i){if(this.element=t,this.mouseIsDown=!1,this.mouseX=-1,this.mouseY=-1,this.animating=!0,this.state="animate",this.listeners=[],this.dx=0,this.dy=0,this.scale=1,this.zoomProgress=0,this.scaleTarget=1,this.scaleStart=1,this.animFunc=e,this.unzoomButton=i,t){var s=this;$(t).mousedown(function(t){s.mouseX=t.pageX-this.offsetLeft,s.mouseY=t.pageY-this.offsetTop,s.mousedown()}),$(t).mouseup(function(t){s.mouseX=t.pageX-this.offsetLeft,s.mouseY=t.pageY-this.offsetTop,s.mouseup()}),$(t).mousemove(function(t){s.mouseX=t.pageX-this.offsetLeft,s.mouseY=t.pageY-this.offsetTop,s.mousemove()})}};u.prototype.mousedown=function(){this.state="mouse-down",this.notify("startMove"),this.landingX=this.mouseX,this.landingY=this.mouseY,this.dxStart=this.dx,this.dyStart=this.dy,this.scaleStart=this.scale,this.mouseIsDown=!0},u.prototype.mousemove=function(){if(!this.mouseIsDown)return void this.notify("hover");var t=this.mouseX-this.landingX,e=this.mouseY-this.landingY,i=Math.abs(t)+Math.abs(e);(i>2||"pan"==this.state)&&(this.state="pan",this.dx+=t,this.dy+=e,this.landingX=this.mouseX,this.landingY=this.mouseY,this.notify("move"))},u.prototype.mouseup=function(){return this.mouseIsDown=!1,"pan"==this.state?(this.state="animate",void this.notify("endMove")):void this.zoomClick(this.mouseX,this.mouseY)},u.prototype.add=function(t){this.listeners.push(t)},u.prototype.notify=function(t){if(this.unzoomButton){var e=Math.abs(this.scale-1)>.001||Math.abs(this.dx)>.001||Math.abs(this.dy>.001);this.unzoomButton.style.visibility=e?"visible":"hidden"}if(!this.animFunc||this.animFunc())for(var i=0;i<this.listeners.length;i++){var s=this.listeners[i];s[t]&&s[t].call(s,this)}},u.prototype.unzoom=function(){this.zoom(0,0,1)},u.prototype.removeMask=function(){this.notify("remove")},u.prototype.zoomClick=function(t,e){var i=1.7,s=1.7*this.scale,o=t-i*(t-this.dx),n=e-i*(e-this.dy);this.zoom(o,n,s)},u.prototype.zoom=function(t,e,i){this.state="zoom",this.zoomProgress=0,this.scaleStart=this.scale,this.scaleTarget=i,this.dxTarget=t,this.dyTarget=e,this.dxStart=this.dx,this.dyStart=this.dy,this.notify("startMove")},u.prototype.relativeZoom=function(){return this.scale/this.scaleStart},u.prototype.relativeDx=function(){return this.dx-this.dxStart},u.prototype.relativeDy=function(){return this.dy-this.dyStart},u.prototype.start=function(t){function e(){var t=new Date;s.loop();var o=new Date-t;s.tt_go=setTimeout(e,Math.max(10,i-o))}var i=t||20,s=this;e()},u.prototype.stop=function(){clearTimeout(this.tt_go)},u.prototype.loop=function(){function t(t,i){return e*t+(1-e)*i}if("mouse-down"!=this.state&&"pan"!=this.state){if("animate"==this.state)return void this.notify("animate");if("zoom"==this.state){this.zoomProgress=Math.min(1,this.zoomProgress+.07);var e=(1+Math.cos(Math.PI*this.zoomProgress))/2;this.scale=t(this.scaleStart,this.scaleTarget),this.dx=t(this.dxStart,this.dxTarget),this.dy=t(this.dyStart,this.dyTarget),this.zoomProgress<1?this.notify("move"):(this.state="animate",this.zoomCurrent=this.zoomTarget,this.notify("endMove"))}}};var c=function(t,e,i){this.x=t,this.y=e,this.oldX=-1,this.oldY=-1,this.age=i,this.rnd=Math.random()},f=function(t,e,i,s,o){this.canvas=t,this.projection=o||p,this.field=i,this.numParticles=s,this.first=!0,this.maxLength=i.maxLength,this.imageCanvas=e,this.x0=this.field.x0,this.x1=this.field.x1,this.y0=this.field.y0,this.y1=this.field.y1,this.makeNewParticles(null,!0),this.colors=[],this.rgb="40, 40, 40",this.background="rgb("+this.rgb+")",this.backgroundAlpha="rgba("+this.rgb+", .02)",this.outsideColor="#fff";for(var n=0;256>n;n++)this.colors[n]="rgb("+n+","+n+","+n+")";this.projection&&(this.startOffsetX=this.projection.offsetX,this.startOffsetY=this.projection.offsetY,this.startScale=this.projection.scale)};f.prototype.setAlpha=function(t){this.backgroundAlpha="rgba("+this.rgb+", "+t+")"},f.prototype.makeNewParticles=function(t){num_create=0,this.particles=[];for(var e=0;e<this.numParticles;e++)this.particles.push(this.makeParticle(t))};var y=100;f.prototype.makeParticle=function(t){for(var e=t?t.dx:0,i=t?t.dy:0,s=t?t.scale:1;;){var o=Math.random(),n=Math.random(),a=o*this.x0+(1-o)*this.x1,r=n*this.y0+(1-n)*this.y1;if(0==this.field.maxLength)return new c(a,r,1+y*Math.random());var h=this.field.getValue(a,r),l=h.length()/this.field.maxLength;if((h.x||h.y)&&Math.random()>.9*l){var u=this.projection.project(a,r),f=u.x*s+e,p=u.y*s+i;if(!(0>f||0>p||f>this.canvas.width||p>this.canvas.height))return new c(a,r,1+y*Math.random())}}},f.prototype.startMove=function(){},f.prototype.endMove=function(t){function e(e,i){return e=(e-t.dx)/t.scale,i=(i-t.dy)/t.scale,s.projection.invert(e,i)}function i(t,i){var s=e(t,i);n=Math.min(s.x,n),a=Math.max(s.x,a),r=Math.min(s.y,r),h=Math.max(s.y,h)}if(t.scale<1.1)this.x0=this.field.x0,this.x1=this.field.x1,this.y0=this.field.y0,this.y1=this.field.y1;else{var s=(this.projection,this),o=e(0,0),n=o.x,a=o.x,r=o.y,h=o.y,l=-.2*this.canvas.height;i(l,this.canvas.height),i(this.canvas.width,l),i(this.canvas.width,this.canvas.height),this.x0=Math.max(this.field.x0,n),this.x1=Math.min(this.field.x1,a),this.y0=Math.max(this.field.y0,r),this.y1=Math.min(this.field.y1,h)}tick=0,this.makeNewParticles(t)},f.prototype.animate=function(t){this.moveThings(t),this.draw(t)},f.prototype.move=function(t){var e=this.canvas.width,i=this.canvas.height,s=this.canvas.getContext("2d");s.fillStyle=this.outsideColor;var o=t.dx,n=t.dy,a=t.scale;s.fillRect(0,0,e,i),s.fillStyle=this.background,s.fillRect(o,n,e*a,i*a);var r=t.relativeZoom(),o=t.dx-r*t.dxStart,n=t.dy-r*t.dyStart},f.prototype.moveThings=function(t){for(var e=.03/(t.zoom||1),i=0;i<this.particles.length;i++){var s=this.particles[i];if(s.age>0&&this.field.inBounds(s.x,s.y)){var o=this.field.getValue(s.x,s.y);s.x+=e*o.x,s.y+=e*o.y,s.age--}else this.particles[i]=this.makeParticle(t)}};!function(){var t=2,e=6*t,i=4*t,s=document.createElement("canvas");s.setAttribute("width",e),s.setAttribute("height",i);var o=s.getContext("2d");o.beginPath(),o.moveTo(0,1*t),o.lineTo(0,3*t),o.lineTo(4*t,3*t),o.lineTo(4*t,4*t),o.lineTo(6*t,2*t),o.lineTo(4*t,0),o.lineTo(4*t,1*t),o.closePath(),o.fill(),o.save();Math.PI/180;return function(t,n,a,r){var h=r.angle;isNaN(h)||(t.save(),t.translate(n,a),t.rotate(h),o.fillStyle=r.color||"rgba(0,255,255,1)",o.fill(),t.drawImage(s,e/2*-1,i/2*-1),t.restore())}}();f.prototype.draw=function(t){{var e=this.canvas.getContext("2d"),i=this.canvas.width,s=this.canvas.height;t.zoom||1}this.first?(e.fillStyle=this.background,this.first=!1):e.fillStyle=this.backgroundAlpha,e.fillStyle="rgba(40, 40, 40, 0.95)";var o=t.dx,n=t.dy,a=t.scale,r=i*a,l=s*a,u=e.globalCompositeOperation;e.globalCompositeOperation="destination-in",e.fillRect(o,n,r,l),e.globalCompositeOperation=u;var c=new h(0,0),f=new h(0,0);e.lineWidth=.9;for(var y=0;y<this.particles.length;y++){var p=this.particles[y];if(this.field.inBounds(p.x,p.y)){if(this.projection.project(p.x,p.y,c),c.x=c.x*a+o,c.y=c.y*a+n,(c.x<0||c.y<0||c.x>i||c.y>s)&&(p.age=-2),-1!=p.oldX){{this.field.getValue(p.x,p.y,f)}e.strokeStyle="#ccc",e.beginPath(),e.moveTo(c.x,c.y),e.lineTo(p.oldX,p.oldY),e.stroke()}p.oldX=c.x,p.oldY=c.y}else p.age=-2}};var p={project:function(t,e,i){var s=i||new h;return s.x=t,s.y=e,s},invert:function(t,e,i){var s=i||new h;return s.x=t,s.y=e,s}};e.prototype.project=function(t,e,i){var s=this.map,o=s.pointToPixel(new BMap.Point(t,e)),n=o.x,a=o.y;return i?(i.x=n,i.y=a,i):new h(n,a)},e.prototype.invert=function(t,e){var i=this.map,s=i.pixelToPoint(new BMap.Pixel(t,e));return new h(s.lng,s.lat)};var d,m,v=40,g=3e3;n(),t.getWind=function(t,e){return d?d.getValue(t,e):void 0};var x="http://10.14.85.116/php/wind/data.php";t.loadWind=function(){var t=$("#loading_windspeed"),e=function(e){d=l.read(e,!0),t.hide(),s(map)},i=r(function(){return x+"?_name=micapsdata&vti="+a()+"&type=1000"});return function(){t.show(),i(e)}}(),t.loadWindSpeed=r(function(t,e){return x+"?_name=micapswind&type=1000&lon="+t+"&lat="+e}),t.loadAir=r(function(t,e){return x+"?_name=micapsvalue&lon="+t+"&lat="+e+"&vti=024,048,072&type=zhyb"}),t.loadXSC=function(){var t=function(t){initMicapsLine(map,t)},e=r(function(){return x+"?_name=micapsdata&vti=000&type=h000"});return function(){e(t)}}()}(this);